<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stare Contest - Final Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { touch-action: none; overflow: hidden; background: #0b0e14; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; color: white; }
        #video { transform: scaleX(-1); border-radius: 1rem; border: 4px solid #1f2937; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #introModal { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); }
        .pressure-gradient { background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); }
    </style>
</head>
<body>

    <div id="introModal">
        <div class="glass p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl text-center">
            <h2 class="text-3xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                STARE CONTEST
            </h2>
            <div class="text-left space-y-4 mb-8 text-gray-300">
                <p>üü¢ <b>‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:</b> ‡∏à‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                <p>üö´ <b>‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏´‡πâ‡∏≤‡∏°‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î!</p>
                <p>ü§° <b>‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏™‡πà‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏Ñ‡∏∏‡∏ì</p>
            </div>
            <button onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl font-bold text-lg hover:scale-105 transition-transform active:scale-95 shadow-lg">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <p class="mt-4 text-xs text-gray-500">*‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</p>
        </div>
    </div>

    <div id="gameContainer" class="opacity-20 transition-opacity duration-1000 flex flex-col items-center">
        <h1 class="text-xl font-bold mb-4 tracking-widest text-gray-400">STATUS: <span id="statusTxt" class="text-white">WAITING...</span></h1>
        
        <div class="relative shadow-2xl rounded-2xl overflow-hidden">
            <video id="video" width="400" height="300" autoplay muted></video>
            <canvas id="overlay" class="absolute top-0 left-0"></canvas>
        </div>
        
        <div class="w-72 h-3 bg-gray-800 rounded-full mt-8 overflow-hidden">
            <div id="pressureBar" class="pressure-gradient h-full w-0 transition-all duration-300"></div>
        </div>
        <p class="mt-2 text-xs text-gray-500 uppercase tracking-widest">Pressure Level</p>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const modal = document.getElementById('introModal');
        const gameContainer = document.getElementById('gameContainer');
        const statusTxt = document.getElementById('statusTxt');
        const pressureBar = document.getElementById('pressureBar');

        let isRunning = false;
        let pressure = 0;
        let currentFilters = [];
        const filterTypes = ['moustache', 'clown_nose', 'sunglasses', 'hat', 'crazy_eyes'];

        // ‡πÇ‡∏´‡∏•‡∏î Models ‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡πÄ‡∏•‡∏¢
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://unpkg.com/face-api.js@0.22.2/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://unpkg.com/face-api.js@0.22.2/models'),
            faceapi.nets.faceExpressionNet.loadFromUri('https://unpkg.com/face-api.js@0.22.2/models')
        ]);

        async function startGame() {
            modal.style.display = 'none';
            gameContainer.style.opacity = '1';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                isRunning = true;
                statusTxt.innerText = "EYES ON SCREEN";
                loop();
            } catch (err) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà!");
                location.reload();
            }
        }

        async function loop() {
            if (!isRunning) return;

            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks().withFaceExpressions();

            if (detections) {
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö EAR (Eye Aspect Ratio)
                const leftEye = resizedDetections.landmarks.getLeftEye();
                const rightEye = resizedDetections.landmarks.getRightEye();
                const ear = (getEAR(leftEye) + getEAR(rightEye)) / 2;

                if (ear < 0.22) { // ‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤
                    fail("‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤!");
                } else if (detections.expressions.happy > 0.5) { // ‡∏¢‡∏¥‡πâ‡∏°
                    fail("‡πÅ‡∏≠‡∏ö‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏´‡∏£‡∏≠!");
                } else {
                    // ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô
                    pressure += 0.4;
                    if (pressure >= 100) {
                        pressure = 100;
                        statusTxt.innerText = "YOU ARE A GOD!";
                    }
                    // ‡∏ó‡∏∏‡∏Å‡πÜ 20% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏î‡∏±‡∏ô ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏™‡πà‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
                    if (Math.floor(pressure % 20) === 0 && pressure > 5) {
                        applyFilter();
                    }
                }
                
                pressureBar.style.width = `${pressure}%`;
                drawFilters(resizedDetections);
            }

            requestAnimationFrame(loop);
        }

        function fail(reason) {
            statusTxt.innerText = reason;
            pressure = Math.max(0, pressure - 30);
            if (navigator.vibrate) navigator.vibrate(200);
            applyFilter();
        }

        function applyFilter() {
            const f = filterTypes[Math.floor(Math.random() * filterTypes.length)];
            if (!currentFilters.includes(f)) currentFilters.push(f);
        }

        function getEAR(eye) {
            const v1 = Math.sqrt((eye[1].x-eye[5].x)**2 + (eye[1].y-eye[5].y)**2);
            const v2 = Math.sqrt((eye[2].x-eye[4].x)**2 + (eye[2].y-eye[4].y)**2);
            const h = Math.sqrt((eye[0].x-eye[3].x)**2 + (eye[0].y-eye[3].y)**2);
            return (v1 + v2) / (2 * h);
        }

        function drawFilters(detections) {
            const landmarks = detections.landmarks;
            const nose = landmarks.getNose();
            const jaw = landmarks.getJawOutline();
            const faceWidth = jaw[16].x - jaw[0].x;

            currentFilters.forEach(f => {
                ctx.save();
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1); // Flip back for drawing
                ctx.fillStyle = f === 'clown_nose' ? 'red' : 'brown';
                if (f === 'clown_nose') {
                    ctx.beginPath(); ctx.arc(nose[3].x, nose[3].y, faceWidth*0.08, 0, Math.PI*2); ctx.fill();
                }
                if (f === 'moustache') {
                    ctx.fillRect(nose[3].x - faceWidth*0.15, nose[3].y + 10, faceWidth*0.3, 8);
                }
                ctx.restore();
            });
        }
    </script>
</body>
</html>
